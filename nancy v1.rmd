---
title: "nancy li v1"
output: html_document
date: "2025-10-28"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# ---- Setup ----
# Install packages once if needed:
# install.packages(c("readxl","tidyverse","lubridate","janitor","scales"))

library(readxl)
library(tidyverse)
library(lubridate)
library(janitor)
library(scales)

path  <- "/Users/lllllnx/Desktop/August 2025 Data.xlsx"   
# or another file; not hardcoded dates
use_specific_month <- False         
# TRUE = pick Aug 2024; FALSE = always latest month

# ---- Load & standardize columns ----
df_raw <- read_excel(path, sheet = sheet) |> clean_names()
parse_month <- function(x) {
  if (inherits(x, "Date")) return(as_date(floor_date(x, "month")))
  suppressWarnings(coalesce(
    ymd(x, quiet = TRUE),
    ym(x, quiet = TRUE) |> as_date(),
    my(x, quiet = TRUE) |> as_date(),
    parse_date_time(x, orders = c("Y-m","Ym","b Y","m/Y","m-Y","Y/m/d","m/d/Y"), quiet = TRUE) |> as_date()
  ))
}

# Load NSA from 4th tab ("Non-SA") and SA from "SA"
df_nsa <- read_excel(path, sheet = "Non-SA") |> clean_names() |> mutate(adjustment = "NSA")
df_sa  <- read_excel(path, sheet = "SA")      |> clean_names() |> mutate(adjustment = "SA")

df_raw <- bind_rows(df_nsa, df_sa)


# Try to standardize to: date, industry, value
# Add/adjust synonyms to fit your file’s headers if needed.
df <- df_raw |>
  rename(
    date     = any_of(c("date","month","period","obs_date","ref_date")),
    industry = any_of(c("industry","sector","naics","category","group")),
    value    = any_of(c("value","level","index","amount","series_value"))
  )

# Parse dates robustly (handles Date, "YYYY-MM", "MMM YYYY", etc.)
df <- df |>
  mutate(
    date = case_when(
      inherits(date, "Date") ~ as.Date(date),
      TRUE ~ suppressWarnings(
        # Try multiple common monthly formats
        coalesce(
          ymd(date, quiet = TRUE),
          ym(date, quiet = TRUE),
          my(date, quiet = TRUE) |> as_date(),
          parse_date_time(date, orders = c("Y-m", "Ym", "b Y", "m/Y", "m-Y", "Y/m/d", "m/d/Y"), quiet = TRUE) |> as_date()
        )
      )
    )
  )

# Basic checks
stopifnot(all(c("date","industry","value") %in% names(df)))
df <- df |> filter(!is.na(date), !is.na(industry), !is.na(value))

# ---- Compute latest month & changes vs prior month ----
# Sort within industry, compute lag, then keep the latest month only (no hardcoding)
df_calc <- df |>
  group_by(industry) |>
  arrange(date, .by_group = TRUE) |>
  mutate(
    prev_value = lag(value),
    abs_change = value - prev_value,
    pct_change = (value / prev_value) - 1
  ) |>
  ungroup()

latest_date <- max(df_calc$date, na.rm = TRUE)

latest <- df_calc |>
  filter(date == latest_date) |>
  # keep industries that have a prior-month comparator
  filter(!is.na(prev_value)) |>
  arrange(pct_change)

# ---- Plot: MoM % change by industry (labels show % and abs change) ----
p <- ggplot(latest, aes(x = reorder(industry, pct_change), y = pct_change)) +
  geom_col(width = 0.7) +
  coord_flip() +
  geom_text(
    aes(label = paste0(
      percent(pct_change, accuracy = 0.1),
      " (", comma(abs_change, accuracy = 0.1), ")"
    )),
    hjust = -0.05, size = 3
  ) +
  expand_limits(y = max(0, max(latest$pct_change, na.rm = TRUE)) * 1.12) +
  labs(
    title = paste0("Month-over-Month Change by Industry — ", format(latest_date, "%b %Y")),
    subtitle = "Labels show % change and absolute level change vs previous month",
    x = NULL,
    y = "Percent change vs prior month",
    caption = "Source: internal monthly data"
  ) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  theme_minimal(base_size = 12) +
  theme(panel.grid.minor = element_blank())

print(p)

# ---- Save output (optional) ----
out_dir <- "output"
if (!dir.exists(out_dir)) dir.create(out_dir)
out_file <- file.path(out_dir, paste0("industry_mom_", format(latest_date, "%Y_%m"), ".png"))
ggsave(out_file, p, width = 10, height = 7, dpi = 300)

# ---- Also return a tidy table for export/review (optional) ----
latest_out <- latest |>
  transmute(
    date        = latest_date,
    industry,
    value,
    prev_value,
    abs_change,
    pct_change
  ) |>
  arrange(desc(pct_change))

# View in console:
print(latest_out, n = Inf)

# To export as CSV (optional):
# write_csv(latest_out, file.path(out_dir, paste0("industry_mom_", format(latest_date, "%Y_%m"), ".csv")))

```



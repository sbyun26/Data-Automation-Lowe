---
title: "nancy li v1"
output: html_document
date: "2025-10-28"
---

```{r setup, include=FALSE}
library(readxl)
library(tidyverse)
library(lubridate)
library(janitor)
library(scales)

path <- "/Users/lllllnx/Desktop/August 2025 Data v2.xlsx"

#read a sheet and pivot wide -> long
read_pivot <- function(path, sheet, tag) {
  read_excel(path, sheet = sheet) |>
    clean_names() |>
    # drop empty helper columns like 'unnamed_23' if present
    select(-matches("^unnamed")) |>
    # ensure the month column is called 'month'
    rename(month = any_of("month")) |>
    # pivot all non-month columns to key/value
    pivot_longer(
      cols = -month,
      names_to = "industry",
      values_to = "value"
    ) |>
    mutate(adjustment = tag)
}

df_nsa <- read_pivot(path, "Non-SA", "NSA")

#coerce month to Date if it came in as POSIXct/character
df_nsa <- df_nsa |> mutate(month = as_date(month))

#compute MoM on full history
df_calc <- df_nsa |>
  group_by(adjustment, industry) |>
  arrange(month, .by_group = TRUE) |>
  mutate(
    prev_value = lag(value),
    abs_change = value - prev_value,
    pct_change = (value / prev_value) - 1
  ) |>
  ungroup()

latest_month <- max(df_calc$month, na.rm = TRUE)

latest <- df_calc |>
  filter(month == latest_month, !is.na(prev_value)) |>
  arrange(pct_change)

#plot 
stopifnot(nrow(latest) > 0)

p <- ggplot(latest, aes(x = reorder(industry, pct_change), y = pct_change)) +
  geom_col(width = 0.7) +
  coord_flip() +
  geom_text(
    aes(label = paste0(
      percent(pct_change, accuracy = 0.1),
      " (", comma(abs_change, accuracy = 1), ")"
    )),
    hjust = -0.05, size = 3
  ) +
  expand_limits(y = max(0, max(latest$pct_change, na.rm = TRUE)) * 1.12) +
  labs(
    title    = paste0("Month-over-Month Change by Industry (NSA) — ", format(latest_month, "%b %Y")),
    subtitle = "Labels show % change and absolute level change v.s. previous month",
    x = NULL,
    y = "Percent change v.s. prior month",
    caption = "Source: internal monthly data"
  ) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  theme_minimal(base_size = 12) +
  theme(panel.grid.minor = element_blank())

print(p)

outfile <- sprintf("MoM_by_industry_NSA_%s.png", format(max(latest$month), "%Y-%m"))
ggsave(outfile, plot = p, width = 20, height = 10, dpi = 150)
cat("Saved plot to:", normalizePath(outfile), "\n")
```

```{r setup, include=FALSE}
df_sa <- read_pivot(path, "SA", "SA")

#coerce month to Date if it came in as POSIXct/characteri
df_nsa <- df_nsa |> mutate(month = as_date(month))

#compute MoM on full history
df_calc <- df_nsa |>
  group_by(adjustment, industry) |>
  arrange(month, .by_group = TRUE) |>
  mutate(
    prev_value = lag(value),
    abs_change = value - prev_value,
    pct_change = (value / prev_value) - 1
  ) |>
  ungroup()

latest_month <- max(df_calc$month, na.rm = TRUE)

latest <- df_calc |>
  filter(month == latest_month, !is.na(prev_value)) |>
  arrange(pct_change)

#plot 
stopifnot(nrow(latest) > 0)

p <- ggplot(latest, aes(x = reorder(industry, pct_change), y = pct_change)) +
  geom_col(width = 0.7) +
  coord_flip() +
  geom_text(
    aes(label = paste0(
      percent(pct_change, accuracy = 0.1),
      " (", comma(abs_change, accuracy = 1), ")"
    )),
    hjust = -0.05, size = 3
  ) +
  expand_limits(y = max(0, max(latest$pct_change, na.rm = TRUE)) * 1.12) +
  labs(
    title    = paste0("Month-over-Month Change by Industry (SA) — ", format(latest_month, "%b %Y")),
    subtitle = "Labels show % change and absolute level change v.s. previous month",
    x = NULL,
    y = "Percent change v.s. prior month",
    caption = "Source: internal monthly data"
  ) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  theme_minimal(base_size = 12) +
  theme(panel.grid.minor = element_blank())

print(p)

outfile <- sprintf("MoM_by_industry_SA_%s.png", format(max(latest$month), "%Y-%m"))
ggsave(outfile, plot = p, width = 20, height = 10, dpi = 150)
cat("Saved plot to:", normalizePath(outfile), "\n")
```

